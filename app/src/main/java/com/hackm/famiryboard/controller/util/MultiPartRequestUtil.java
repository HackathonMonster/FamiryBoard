package com.hackm.famiryboard.controller.util;import android.content.Context;import android.util.Log;import com.android.volley.AuthFailureError;import com.android.volley.NetworkResponse;import com.android.volley.Request.Priority;import com.android.volley.RequestQueue;import com.android.volley.Response;import com.android.volley.Response.Listener;import com.android.volley.VolleyError;import com.android.volley.toolbox.Volley;import com.hackm.famiryboard.controller.provider.MultiPartStack;import com.hackm.famiryboard.controller.provider.NetworkTaskCallback;import com.hackm.famiryboard.model.enumerate.NetworkTasks;import com.hackm.famiryboard.model.system.AppConfig;import com.hackm.famiryboard.controller.provider.MultipartRequest;import java.io.File;import java.io.UnsupportedEncodingException;import java.util.HashMap;import java.util.Map;//ストアの一覧を取得public class MultiPartRequestUtil {    private NetworkTaskCallback mCallback;    private String mRequestFrom;    private Map<String, String> mHeaders = new HashMap<String, String>();    private Context mContext;    public MultiPartRequestUtil(final NetworkTaskCallback callback, final String requestFrom, Map<String, String> headers) {        this.mCallback = callback;        this.mRequestFrom = requestFrom;        if (headers != null) {            this.mHeaders = headers;        }    }    public void onRequest(Context context, final Priority requestPriority, final String url, final NetworkTasks task, final Map<String, String> stringParts, final Map<String, File> fileParts) {        mContext = context;        final RequestQueue mQueue = Volley.newRequestQueue(context, new MultiPartStack());        if (AppConfig.DEBUG) Log.d(this.getClass().getSimpleName(), url);        MultipartRequest request = new MultipartRequest(url,                new Listener<String>() {                    @Override                    public void onResponse(String response) {                        try {                            if (AppConfig.DEBUG)                                Log.d(this.getClass().getSimpleName(), "response:" + response.toString());                            if (mCallback != null)                                mCallback.onSuccessNetworkTask(task.id, response);                        } catch (IllegalStateException e) {                            e.printStackTrace();                        }                    }                },                new Response.ErrorListener() {                    @Override                    public void onErrorResponse(VolleyError error) {                        String response = null;                        if (error != null) {                            response = error.toString();                            if (error.networkResponse != null && error.networkResponse.data != null) {                                try {                                    response = new String(error.networkResponse.data, "utf-8");                                } catch (UnsupportedEncodingException e) {                                    e.printStackTrace();                                }                            }                        }                        if (AppConfig.DEBUG)                            Log.d(this.getClass().getSimpleName(), "error:" + error.toString());                        try {                            if (mCallback != null) mCallback.onFailedNetworkTask(task.id, response);                        } catch (IllegalStateException e) {                            e.printStackTrace();                        }                    }                },                stringParts,                fileParts) {            @Override            protected Response<String> parseNetworkResponse(NetworkResponse response) {                Map<String, String> headers = response.headers;                if (headers.containsKey("Set-Cookie")) {                    String cookie = headers.get("Set-Cookie");                    mContext.getSharedPreferences(AppConfig.PREF_NAME, Context.MODE_PRIVATE)                            .edit()                            .putString(AppConfig.PREF_SAVED_COOKIE, cookie)                            .commit();                    if (AppConfig.DEBUG) {                        Log.d("Contains Set-Cookie", "cookie:" + cookie);                    }                }                return super.parseNetworkResponse(response);            }            @Override            public Map<String, String> getHeaders() throws AuthFailureError {                mHeaders.putAll(super.getHeaders());                mHeaders.put("User-Agent", "Mozilla/5.0");                mHeaders.put("Cache-Control", "no-cache");                String cookieStr = mContext.getSharedPreferences(AppConfig.PREF_NAME, Context.MODE_PRIVATE).getString(AppConfig.PREF_SAVED_COOKIE, "");                if (cookieStr.length() > 0) {                    mHeaders.put("Cookie", cookieStr);                }                return mHeaders;            }        };        request.setPriority(requestPriority);        request.setTag(mRequestFrom);        mQueue.add(request);    }}